From: James Westby <james.westby@linaro.org>
Date: Thu, 28 Oct 2010 09:14:26 -0400
Subject: Fix the race that leads to the password box disappearing, but the dialog remaining.
Bug: http://bugs.freedesktop.org/show_bug.cgi?id=30515
Bug-Ubuntu: https://launchpad.net/bugs/649939
Bug-Ubuntu: https://launchpad.net/bugs/445303

Index: polkit-0.99/src/polkitagent/polkitagentsession.c
===================================================================
--- polkit-0.99.orig/src/polkitagent/polkitagentsession.c	2010-08-21 02:17:50.000000000 +1000
+++ polkit-0.99/src/polkitagent/polkitagentsession.c	2010-11-02 17:36:36.836591075 +1100
@@ -309,9 +309,14 @@
                   gpointer user_data)
 {
   PolkitAgentSession *session = POLKIT_AGENT_SESSION (user_data);
+  GMainContext *context = g_main_context_default();
 
   /* kill all the watches we have set up, except for the child since it has exited already */
   session->child_pid = 0;
+  /* Allow the stdout of the child to be processed if we haven't finished yet */
+  while (g_main_context_pending(context)) {
+      g_main_context_iteration(context, FALSE);
+  }
   kill_helper (session);
 }
 
@@ -493,15 +498,15 @@
       goto error;
     }
 
-  session->child_watch_source = g_child_watch_source_new (session->child_pid);
-  g_source_set_callback (session->child_watch_source, (GSourceFunc) child_watch_func, session, NULL);
-  g_source_attach (session->child_watch_source, g_main_context_get_thread_default ());
-
   session->child_stdout_channel = g_io_channel_unix_new (session->child_stdout);
   session->child_stdout_watch_source = g_io_create_watch (session->child_stdout_channel, G_IO_IN);
   g_source_set_callback (session->child_stdout_watch_source, (GSourceFunc) io_watch_have_data, session, NULL);
   g_source_attach (session->child_stdout_watch_source, g_main_context_get_thread_default ());
 
+  session->child_watch_source = g_child_watch_source_new (session->child_pid);
+  g_source_set_callback (session->child_watch_source, (GSourceFunc) child_watch_func, session, NULL);
+  g_source_attach (session->child_watch_source, g_main_context_get_thread_default ());
+
 
   session->success = FALSE;
 
